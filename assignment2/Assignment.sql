CREATE TABLE MEDICINE(
    MEDICINE_ID VARCHAR2(5) NOT NULL PRIMARY KEY,
    MEDICINE_NAME VARCHAR2(50),
    MEDICINE_PRICE NUMBER(7,2),
    MEDICINE_DESCRIPTION VARCHAR2(80)
);

SELECT * FROM MEDICINE;

DROP TABLE MEDICINE;

INSERT INTO MEDICINE VALUES('22001', 'Acriflavin 0.1% Lotion 5ml', 10.00, 'Infected skin, lesions, cuts, abrasions, wounds and burns');
INSERT INTO MEDICINE VALUES('22002', 'Tincture Ipecac', 1.00, 'Cough'); 
INSERT INTO MEDICINE VALUES('22003', 'Aqueous Cream 5 ml', 8.00, 'Dry skin');
INSERT INTO MEDICINE VALUES('22004', 'Ascorbic Acid 100 mg Tablet', 0.50, 'Vitamin C deficiency');
INSERT INTO MEDICINE VALUES('22005', 'Bisacodyl 5 mg Tablet', 1.20, 'Constipation');
INSERT INTO MEDICINE VALUES('22006', 'Calamine Cream 10 ml', 7.50, 'Relieves minor skin irritations');
INSERT INTO MEDICINE VALUES('22007', 'Charcoal, Activated 250 mg Tablet', 0.80, 'Diarrhoea and food poisoning');
INSERT INTO MEDICINE VALUES('22008', 'Chloramphenicol 0.5% Eye Drops 10 ml', 20.00, 'Broad spectrum antibiotic in superficial eye infections');
INSERT INTO MEDICINE VALUES('22009', 'Methyl Salicylate 25% Ointment 10 ml', 16.80, 'Relief of minor aches and pains of muscles and joints');
INSERT INTO MEDICINE VALUES('22010', 'Miconazole 2% Cream 15 ml', 23.20, 'Antifungal agent');
INSERT INTO MEDICINE VALUES('22011', 'Oral Rehydration Salt 20.5 g' ,0.25, 'Replacement of fluid and electrolytes loss in diarrhoea');
INSERT INTO MEDICINE VALUES('22012', 'Paracetamol 120 mg', 0.85, 'Mild to moderate pain and pyrexia');
INSERT INTO MEDICINE VALUES('22013', 'Prochlorperazine Maleate 5mg Tablet', 2.00, 'Severe nausea and vomiting');
INSERT INTO MEDICINE VALUES('22014', 'Salbutamol 0.5% Inhalation Solution 50 ml', 21.60, 'Asthma and reversible airways obstruction');
INSERT INTO MEDICINE VALUES('22015', 'Tetanus Toxoid Injection', 120.00, 'Immunization against tetanus infection');
INSERT INTO MEDICINE VALUES('22016', 'Thymol Compound Gargle 100 ml', 6.20, 'For sore throat and minor mouth inflammation');
INSERT INTO MEDICINE VALUES('22017', 'Vitamin B Complex Tablet 30 mg', 1.20, 'Prophylaxis and treatment of vitamin B deficiency');
INSERT INTO MEDICINE VALUES('22018', 'Water for Injection 10 ml', 1.00, 'As a diluent for the administration of medications');
INSERT INTO MEDICINE VALUES('22019', 'Zinc Oxide Talet 30 mg', 2.60, 'For relief of burning and soreness in haemorrhoids');
INSERT INTO MEDICINE VALUES('22020', 'Zink Oxide Cream 30 ml', 35.00, 'Skin protective in various skin conditions such as eczema');
INSERT INTO MEDICINE VALUES('22021', 'Diphenhydramine Hydrochloride 14 mg', 1.00, 'Cough');
INSERT INTO MEDICINE VALUES('22022', 'Ferrous Fumarate 200 mg Tablet', 3.30, 'Prevention and treatment of iron-deficiency anaemias');
INSERT INTO MEDICINE VALUES('22023', 'Folic Acid 5 mg Tablet', 1.50, 'For the prevention and treatment of folate deficiency states ');
INSERT INTO MEDICINE VALUES('22024', 'Glyceryl Trinitrate 0.5 mg Tablet', 2.10, 'Prophylaxis, treatment of angina and left ventricular failure');
INSERT INTO MEDICINE VALUES('22025', 'Magnesium Trisilicate Tablet', 4.10, 'Heartburn, dyspepsia');
INSERT INTO MEDICINE VALUES('22026', 'Hypromellose 0.3% Eye Drop 10 ml', 9.50, 'For relief of dry eyes and eye irritation');
INSERT INTO MEDICINE VALUES('22027', 'Rabies Vaccine Injection', 240.00, 'For prevention against rabies');
INSERT INTO MEDICINE VALUES('22028', 'Cholera Vaccine Injection', 120.00, 'For prevention against cholera');
INSERT INTO MEDICINE VALUES('22029', 'Hepatitis A Vaccine Injection', 99.00, 'For prevention against Hepatitis A');
INSERT INTO MEDICINE VALUES('22030', 'Hepatitis B Vaccine Injection', 99.00, 'For prevention against Hepatitis B');

CREATE TABLE PATIENT(
    PATIENT_ID VARCHAR2(5) NOT NULL PRIMARY KEY,
    PATIENT_FNAME VARCHAR2(20) NOT NULL,
    PATIENT_LNAME VARCHAR2(20) NOT NULL,
    PATIENT_GENDER CHAR(1) CHECK (PATIENT_GENDER IN('F','M')),
    PATIENT_ICNUMBER VARCHAR2(15),
    PATIENT_STREETNAME VARCHAR2(30),
    PATIENT_CITY VARCHAR2(15),
    PATIENT_ZIPCODE CHAR(5),
    PATIENT_CONTACTNO VARCHAR2(12)
);

SELECT * FROM PATIENT;

DROP TABLE PATIENT;

INSERT INTO PATIENT VALUES('00001','Yin','Zhu','F','650213-01-5354','Jalan Matahari 22','Johor Bahru','81100','013-8954445');
INSERT INTO PATIENT VALUES('00002','Xing Xing','Chou','M','600131-01-5753','Jalan Harimau 1','Johor Bahru','81100','012-9856633');
INSERT INTO PATIENT VALUES('00003','Yu He','Ho','F','891112-08-9682','Jalan Beruang 34','Ulu Tiram','81800','011-11754444');
INSERT INTO PATIENT VALUES('00004','Siti Aisyah','Binti Ahmed','F','991214-01-6150','Jalan Kenanga 45','Kota Tinggi','81900','013-8955566');
INSERT INTO PATIENT VALUES('00005','Kumar','Prashant','M','890109-01-8123','Jalan Anggerik 52','Johor Bahru','81100','019-7858855');
INSERT INTO PATIENT VALUES('00006','Ujjwal','Sinha','M','550101-01-5113','Jalan Bakawali 1','Johor Bahru','81100','011-11117521');
INSERT INTO PATIENT VALUES('00007','Theevashini','A/P Rajen','F','990924-01-6182','Jalan Desa Tebrau 20','Johor Bahru','81100','016-9856621');
INSERT INTO PATIENT VALUES('00008','Safiyya Aliaa','Binti Abu Bakar','F','960624-01-6236','Jalan Seroja 34','Kulai','81000','011-11235333');
INSERT INTO PATIENT VALUES('00009','Washil','Al Ahdab','M','100304-01-8355','Jalan Seroja 33','Kulai','81000','018-7546522');
INSERT INTO PATIENT VALUES('00010','Suveetha','A/P Sukumaran','F','990324-01-6156','Jalan Gaya','Johor Bahru','81100','013-9665562');

CREATE TABLE MEDICAL_RECORD(
    RECORD_ID VARCHAR2(5) NOT NULL PRIMARY KEY,
    RECORD_DIAGNOSIS VARCHAR2(50),
    RECORD_SERVICENAME VARCHAR2(15) CHECK(RECORD_SERVICENAME IN('Consultation','Operation','Screening Test','Vaccination')),
    RECORD_DESCRIPTION VARCHAR2(50),
    PATIENT_ID VARCHAR2(5) REFERENCES PATIENT(PATIENT_ID)
);

SELECT * FROM MEDICAL_RECORD;

DROP TABLE MEDICAL_RECORD;

INSERT INTO MEDICAL_RECORD VALUES('10001','Throat Inflammation','Consultation','Caused by flu','00001');
INSERT INTO MEDICAL_RECORD VALUES('10002','Tetanus','Vaccination','Tetanus positive, seizure, jaw cramping','00002');
INSERT INTO MEDICAL_RECORD VALUES('10003','Red Eyes','Consultation','Caused by over-wearing contact lenses','00003');
INSERT INTO MEDICAL_RECORD VALUES('10004','Second-degree Burns','Consultation','Accidents with ovens and stoves','00004');
INSERT INTO MEDICAL_RECORD VALUES('10005','Anaemia','Consultation','Iron-deficiency anemia','00005');
INSERT INTO MEDICAL_RECORD VALUES('10006','High Blood Pressure','Screening Test','High blood pressure possitive: 140/90mmHg','00006');
INSERT INTO MEDICAL_RECORD VALUES('10007','Urinary Test','Screening Test','Pregnancy positive, severe nausea, vomitting','00007');
INSERT INTO MEDICAL_RECORD VALUES('10008','Food Poisoning','Consultation','Possibly taken contaminated food','00008');
INSERT INTO MEDICAL_RECORD VALUES('10009','Circumcision','Operation','Long foreskin from genital area, good recovery','00009');
INSERT INTO MEDICAL_RECORD VALUES('10010','Cholera Vaccine','Vaccination','Travel Vaccination','00010');

CREATE TABLE DOCTOR(
    DOCTOR_ID VARCHAR2(5) NOT NULL PRIMARY KEY,
    DOCTOR_FNAME VARCHAR2(20) NOT NULL,
    DOCTOR_LNAME VARCHAR2(20) NOT NULL,
    DOCTOR_GENDER CHAR(1) CHECK (DOCTOR_GENDER IN('F','M')),
    DOCTOR_ICNUMBER VARCHAR2(15),
    DOCTOR_CONTACTNO VARCHAR2(12),
    DOCTOR_QUALIFICATION VARCHAR2(30),
    DOCTOR_SPECIALISATION VARCHAR2(40)
);

SELECT * FROM DOCTOR;

DROP TABLE DOCTOR;

INSERT INTO DOCTOR VALUES('88001','Dr Ming Feng','Chan','F','601130-01-5124','011-11526332','MMED in Universiti Malaya','Family Medicine');
INSERT INTO DOCTOR VALUES('88002','Dr Stephen','Chou','M','890113-01-6133','019-7599632','MBBS in University of Adelaide','Medicine');

CREATE TABLE SCHEDULE (
    SCHEDULE_ID     VARCHAR2(5) NOT NULL PRIMARY KEY,
    SCHEDULE_DAY    VARCHAR2(3),
    SCHEDULE_TIME   VARCHAR2(5),
    DOCTOR_ID       VARCHAR2(5),
    FOREIGN KEY ( DOCTOR_ID ) REFERENCES DOCTOR
);

SELECT * FROM SCHEDULE;

DROP TABLE SCHEDULE;

INSERT INTO SCHEDULE VALUES ('20011','MON','10:00','88002');
INSERT INTO SCHEDULE VALUES ('20012','MON','15:00','88001');
INSERT INTO SCHEDULE VALUES ('20013','TUE','10:00','88002');
INSERT INTO SCHEDULE VALUES ('20014','TUE','15:00','88001');
INSERT INTO SCHEDULE VALUES ('20015','WED','10:00','88002');
INSERT INTO SCHEDULE VALUES ('20016','WED','15:00','88001');
INSERT INTO SCHEDULE VALUES ('20017','THU','10:00','88002');
INSERT INTO SCHEDULE VALUES ('20018','THU','15:00','88001');
INSERT INTO SCHEDULE VALUES ('20019','FRI','10:00','88002');
INSERT INTO SCHEDULE VALUES ('20020','FRI','15:00','88001');
INSERT INTO SCHEDULE VALUES ('20021','SAT','10:00','88002');
INSERT INTO SCHEDULE VALUES ('20022','SUN','10:00','88001');

CREATE TABLE APPOINTMENT(
    APPOINTMENT_ID  NUMBER(5) NOT NULL PRIMARY KEY,
    APPOINTMENT_DATETIME DATE,
    APPOINTMENT_DESCRIPTION VARCHAR2 (30),
    DOCTOR_ID  VARCHAR2(5) REFERENCES DOCTOR(DOCTOR_ID),
    PATIENT_ID  VARCHAR2(5) REFERENCES PATIENT(PATIENT_ID)
);

DESCRIBE APPOINTMENT;

SELECT * FROM APPOINTMENT;

DROP TABLE APPOINTMENT;

INSERT INTO APPOINTMENT VALUES(1,TO_DATE('2013/05/03 10:00:44', 'yyyy/mm/dd hh24:mi:ss'),'Sore throat, cough','88002','00001');
INSERT INTO APPOINTMENT VALUES(2,TO_DATE('2013/10/01 13:45:41', 'yyyy/mm/dd hh24:mi:ss'),'Possible tetanus from rust','88002','00002');
INSERT INTO APPOINTMENT VALUES(3,TO_DATE('2014/01/01 16:00:30', 'yyyy/mm/dd hh24:mi:ss'),'Sore eye, dryness','88001','00003');
INSERT INTO APPOINTMENT VALUES(4,TO_DATE('2015/08/24 17:15:26', 'yyyy/mm/dd hh24:mi:ss'),'Blister from burn','88001','00004');
INSERT INTO APPOINTMENT VALUES(5,TO_DATE('2016/02/11 11:15:08', 'yyyy/mm/dd hh24:mi:ss'),'Dizzy, breathing difficulties','88002','00005');
INSERT INTO APPOINTMENT VALUES(6,TO_DATE('2016/03/03 12:45:36', 'yyyy/mm/dd hh24:mi:ss'),'Severe headaches, chest pain','88002','00006');
INSERT INTO APPOINTMENT VALUES(7,TO_DATE('2017/07/13 20:30:01', 'yyyy/mm/dd hh24:mi:ss'),'Run urinary test','88001','00007');
INSERT INTO APPOINTMENT VALUES(8,TO_DATE('2017/08/21 21:20:12', 'yyyy/mm/dd hh24:mi:ss'),'Vomit, diarrhea, nausea','88001','00008');
INSERT INTO APPOINTMENT VALUES(9,TO_DATE('2018/04/01 14:50:45', 'yyyy/mm/dd hh24:mi:ss'),'Cicumcision operation','88001','00009');
INSERT INTO APPOINTMENT VALUES(10,TO_DATE('2018/07/14 15:30:00', 'yyyy/mm/dd hh24:mi:ss'),'Cholera vaccination','88002','00010');
 
CREATE TABLE PRESCRIPTION(
    PRESCRIPTION_ID VARCHAR2(5) NOT NULL PRIMARY KEY,
    PRESCRIPTION_DATE DATE,
    APPOINTMENT_ID NUMBER(5) REFERENCES APPOINTMENT(APPOINTMENT_ID)
);

SELECT * FROM PRESCRIPTION;

DROP TABLE PRESCRIPTION;

INSERT INTO PRESCRIPTION VALUES('99001','03-MAY-13',1);
INSERT INTO PRESCRIPTION VALUES('99002','01-OCT-13',2);
INSERT INTO PRESCRIPTION VALUES('99003','01-JAN-14',3);
INSERT INTO PRESCRIPTION VALUES('99004','24-AUG-15',4);
INSERT INTO PRESCRIPTION VALUES('99005','11-FEB-16',5);
INSERT INTO PRESCRIPTION VALUES('99006','03-MAR-16',6);
INSERT INTO PRESCRIPTION VALUES('99007','13-JUL-17',7);
INSERT INTO PRESCRIPTION VALUES('99008','21-AUG-17',8);
INSERT INTO PRESCRIPTION VALUES('99009','01-APR-18',9);
INSERT INTO PRESCRIPTION VALUES('99010','14-JUL-18',10);

CREATE TABLE TREATMENT(
    PRESCRIPTION_ID VARCHAR2 (5) NOT NULL,
    MEDICINE_ID VARCHAR2 (5) NOT NULL,
    TREATMENT_DOSAGE NUMBER(2),
    TREATMENT_PERIOD NUMBER(2),
    PRIMARY KEY (PRESCRIPTION_ID,MEDICINE_ID),
    FOREIGN KEY (MEDICINE_ID) REFERENCES MEDICINE, 
    FOREIGN KEY (PRESCRIPTION_ID) REFERENCES PRESCRIPTION
);

DESCRIBE TREATMENT;

SELECT * FROM TREATMENT
ORDER BY MEDICINE_ID;

DROP TABLE TREATMENT;

INSERT INTO TREATMENT VALUES('99001','22002',2,5);
INSERT INTO TREATMENT VALUES('99002','22015',1,1);
INSERT INTO TREATMENT VALUES('99003','22026',1,1);
INSERT INTO TREATMENT VALUES('99004','22001',2,7); 
INSERT INTO TREATMENT VALUES('99005','22022',3,14);
INSERT INTO TREATMENT VALUES('99006','22025',1,5);
INSERT INTO TREATMENT VALUES('99007','22023',2,30);
INSERT INTO TREATMENT VALUES('99008','22013',2,3);
INSERT INTO TREATMENT VALUES('99009','22012',1,7);
INSERT INTO TREATMENT VALUES('99010','22028',1,1);

--To calculate the total amount of medicine in a period of time
ALTER TABLE TREATMENT ADD MEDICINE_TOTALAMOUNT NUMBER(2);

UPDATE TREATMENT
    SET MEDICINE_TOTALAMOUNT = TREATMENT_DOSAGE * TREATMENT_PERIOD;

--To calculate the total price of medicine from total medicine
ALTER TABLE TREATMENT ADD MEDICINE_TOTALPRICE NUMBER(7,2);

UPDATE TREATMENT
    SET MEDICINE_TOTALPRICE = MEDICINE_TOTALAMOUNT *
        (SELECT MEDICINE_PRICE FROM MEDICINE 
            WHERE MEDICINE.MEDICINE_ID = TREATMENT.MEDICINE_ID);

----------------
CREATE TABLE BILL(
    BILL_ID VARCHAR2 (5) NOT NULL PRIMARY KEY,
    BILL_FEE NUMBER (7,2),
    PRESCRIPTION_ID VARCHAR2(5) REFERENCES PRESCRIPTION(PRESCRIPTION_ID) 
);

DESCRIBE BILL;

SELECT * FROM BILL;

DROP TABLE BILL;

INSERT INTO BILL VALUES('B0001','10.00','99001');
INSERT INTO BILL VALUES('B0002','120.00','99002');
INSERT INTO BILL VALUES('B0003','9.50','99003');
INSERT INTO BILL VALUES('B0004','140.00','99004');
INSERT INTO BILL VALUES('B0005','138.60','99005');
INSERT INTO BILL VALUES('B0006','20.50','99006');
INSERT INTO BILL VALUES('B0007','90.00','99007');
INSERT INTO BILL VALUES('B0008','12.00','99008');
INSERT INTO BILL VALUES('B0009','5.95','99009');
INSERT INTO BILL VALUES('B0010','120.00','99010');

UPDATE BILL
    SET BILL_FEE = 
        (SELECT MEDICINE_TOTALPRICE FROM TREATMENT T, PRESCRIPTION P
        WHERE T.PRESCRIPTION_ID = P.PRESCRIPTION_ID);
       
 SELECT MEDICINE_TOTALPRICE FROM TREATMENT T, PRESCRIPTION P, BILL B
        WHERE T.PRESCRIPTION_ID = P.PRESCRIPTION_ID
        AND P.PRESCRIPTION_ID = B.PRESCRIPTION_ID;


------DML STARTS HERE------

--aggregate function: AVG
SELECT MEDICINE_NAME, MEDICINE_DESCRIPTION, MEDICINE_PRICE
    FROM MEDICINE
        WHERE MEDICINE_PRICE < (SELECT AVG(MEDICINE_PRICE) FROM MEDICINE)
        AND MEDICINE_NAME LIKE '%mg%'
            ORDER BY MEDICINE_PRICE;
            
SELECT AVG(MEDICINE_PRICE) FROM MEDICINE;
--28.64
    
    SELECT * FROM SCHEDULE;
SELECT MAX(SCHEDULE_ID) FROM SCHEDULE;

--group by         
SELECT SCHEDULE_DAY, COUNT(SCHEDULE_ID), MAX(SCHEDULE_ID)  
    FROM SCHEDULE 
        GROUP BY SCHEDULE_DAY
         HAVING COUNT(SCHEDULE_ID) > 1
            ORDER BY MAX(SCHEDULE_ID);

--a view
CREATE VIEW PATIENT_IN_KULAI AS
    SELECT PATIENT_FNAME, PATIENT_LNAME, PATIENT_CONTACTNO, RECORD_DIAGNOSIS
        FROM PATIENT P, MEDICAL_RECORD M
            WHERE P.PATIENT_ID = M.PATIENT_ID
            AND PATIENT_ZIPCODE = '81000'
                ORDER BY P.PATIENT_ID DESC;

DROP VIEW PATIENT_IN_KULAI;

SELECT * FROM PATIENT_IN_KULAI;

--select from which row
SELECT * FROM PATIENT WHERE ROWNUM <= 10;

SELECT PATIENT_ID, PATIENT_FNAME, PATIENT_LNAME, PATIENT_CONTACTNO
    FROM PATIENT
        ORDER BY PATIENT_ID
        OFFSET 3 ROWS FETCH FIRST 40 PERCENT ROWS ONLY;
        
--transpose rows into columns, aggregating data in the process of the transposing
--pivot operation returns more columns and fewer rows than the starting data set
SELECT * FROM (SELECT PATIENT_GENDER, PATIENT_CITY FROM PATIENT)
PIVOT(
    COUNT(*)
    FOR PATIENT_CITY
    IN ('Johor Bahru','Kulai','Ulu Tiram')
);

--inner join: select rows with match values
SELECT MEDICINE_ID,MEDICINE_PRICE
    FROM TREATMENT
        INNER JOIN MEDICINE USING (MEDICINE_ID)
        ORDER BY MEDICINE_ID;
                
--a more complicated ver
SELECT MEDICINE_ID, SUM(TREATMENT_DOSAGE * ROUND(DBMS_RANDOM.VALUE(40,100) ) ) AS RANDOM_MEDICINE_AMOUNT
    FROM TREATMENT
        INNER JOIN MEDICINE USING (MEDICINE_ID)
--1) select row that have same value 
            WHERE ROUND(MEDICINE_PRICE, 0)> 10
--2) whereas among these row, only those row have their medicine_price round off to be >10, will be chosen
                GROUP BY ROLLUP(MEDICINE_ID);
                
CREATE OR REPLACE PROCEDURE CHANGE_SCHEDULE
(SCHEDULEID IN VARCHAR2, 
 SCHEDULEDAY IN CHAR, 
SCHEDULETIME IN VARCHAR2,
DOCTORID IN VARCHAR2
)
AS
BEGIN
DELETE FROM SCHEDULE 
WHERE SCHEDULE.SCHEDULE_DAY = SCHEDULEDAY 
AND SCHEDULE.SCHEDULE_TIME = SCHEDULETIME;
INSERT INTO SCHEDULE VALUES(SCHEDULEID, SCHEDULEDAY, SCHEDULETIME, DOCTORID);
END;

EXEC CHANGE_SCHEDULE ('20011','MON','10:00','88001');

SELECT * FROM SCHEDULE;

TOTAL_BILL_LAST_7_DAYS

SELECT SUM(BILL_FEE) as TOTAL_BILL_LAST_7_DAYS from BILL 
    WHERE SYSDATE - 7 < 
        (SELECT PRESCRIPTION_DATE FROM PRESCRIPTION 
         WHERE PRESCRIPTION.PRESCRIPTION_ID = BILL.PRESCRIPTION_ID);
         
         SELECT SUM(BILL_FEE) as Total_Bill_Last_7_Days from BILL 
    			where SYSDATE - 7 < 
  			(select PRESCRIPTION_DATE from PRESCRIPTION 
            		where PRESCRIPTION_ID = bill.prescription_id);
                    
             